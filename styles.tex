% ==============================================================================
% 1. 文档类与基础设置
% ==============================================================================
% 设置 CJK 字体：主要解决加粗（黑体）和斜体（楷体）的映射
\setCJKmainfont{FandolSong-Regular.otf}[
    BoldFont = FandolHei-Regular.otf,
    ItalicFont = FandolKai-Regular.otf
]
\setmainfont{Times New Roman} % 英文字体使用 Times New Roman
% \setmainfont{times.ttf}

% 章节标题样式设置
\ctexset {
    chapter = { 
        pagestyle = headings
    },
    section = { 
        beforeskip = 3em
    },
    subsection = {
    beforeskip = {1.5em plus .5em minus .2em}, % 缩小上方间距
    afterskip = {1.0em plus .2em},            % 缩小下方间距
    fixskip = true,                            % 修正不必要的间距
    },
    subsubsection = { 
        aftername = {.\ }, 
        beforeskip = 0.5em,
        afterskip = 0.5em
    }
}

% 行间距：1.5倍行距
\renewcommand{\baselinestretch}{1.5} 

% ==============================================================================
% 2. 常用宏包加载
% ==============================================================================
\usepackage{array, tabularray, makecell, multirow, diagbox} % 表格增强
\usepackage{amsmath, amssymb, amsthm, unicode-math}         % 数学公式与字体
\setmathfont{TeX Gyre Termes Math}                           % 数学字体匹配 Times

\usepackage{calc, caption}                                   % 计算与标题控制
\captionsetup[figure]{labelsep=none}                         % 去掉图片编号后的分隔符

\usepackage{enumitem, etoolbox, float, multicol}             % 列表、工具、浮动体、多栏
\let\longdivision\undefined
\usepackage{longdivision, polynom, xlop}                    % 长除法、多项式、算术竖式
\usepackage{rotating, wrapfig}                               % 旋转与文字环绕
\usepackage{xparse, tcolorbox}                               % 高级参数解析与彩色框
\tcbuselibrary{theorems, skins, breakable}

% 页面边距设置
\usepackage{geometry}
\geometry{a4paper,left=2cm,right=2cm,top=2cm,bottom=1cm}

% 超链接设置
\usepackage{hyperref}
\hypersetup{
    colorlinks=false, 
    pdfborder={0 0 0} % 隐藏红框
}

% 绘图相关
\usepackage{tikz}
\usetikzlibrary{arrows.meta, calc, decorations.pathmorphing, intersections, patterns, patterns.meta, through}

% ==============================================================================
% 3. 计数器与编号重定义
% ==============================================================================
\setcounter{secnumdepth}{3}  % 编号深度到 subsubsection
\setcounter{tocdepth}{2}     % 目录深度到 subsection

% 编号格式重定义
\renewcommand{\thesubsection}{\thesection.\arabic{subsection}}
\renewcommand{\thesubsubsection}{\arabic{subsubsection}}
\renewcommand{\thefigure}{\thechapter.\arabic{figure}}

% 脚注带圈编号，且不按章节重置
\renewcommand{\thefootnote}{\circled{\arabic{footnote}}}
\counterwithout*{footnote}{chapter}

% ==============================================================================
% 4. 自定义命令（工具类）
% ==============================================================================

% 绘制带圈数字 \circled{1}
\newcommand{\circled}[2][]{\tikz[baseline=(char.base)]
    {\node[shape = circle, draw, inner sep = 1pt]
    (char) {\phantom{\ifblank{#1}{#2}{#1}}};
    \node at (char.center) {\makebox[0pt][c]{#2}};}}
\robustify{\circled}

% 罗马数字 \rmnum{1} (小写), \Rmnum{1} (大写)
\makeatletter
\newcommand{\rmnum}[1]{\romannumeral #1}
\newcommand{\Rmnum}[1]{\expandafter\@slowromancap\romannumeral #1@}
\makeatother

\newcommand{\bs}[1]{\symbfit{#1}}                      % 数学加粗向量样式
\newcommand{\degree}{^\circ}                           % 度数符号

% 数学符号简化
\newcommand{\R}{\mathbb{R}}
\renewcommand{\d}{\text{d}}
\renewcommand{\frac}[2]{\dfrac{#1}{#2}}   % 强制分式为行间大小

% 弧形符号绘制 \myarc{AB}
\makeatletter
\DeclareFontFamily{U}{tipa}{}
\DeclareFontShape{U}{tipa}{m}{n}{<->tipa10}{}
\newcommand{\myarc@char}{{\usefont{U}{tipa}{m}{n}\symbol{62}}}
\newcommand{\myarc}[1]{\mathpalette\myarc@arc{#1}}
\newcommand{\myarc@arc}[2]{
  \sbox0{$\m@th#1#2$}
  \vbox{ \hbox{\resizebox{\wd0}{\height}{\myarc@char}} \nointerlineskip \box0 }
}
\makeatother

% ==============================================================================
% 5. 自定义环境（解题、证明、习题）
% ==============================================================================

% 例题环境 \eg
\newcounter{cnteg}[chapter]
\newcommand{\eg}{\stepcounter{cnteg}\textbf{例\thechapter.\thecnteg\ \ }}

% 解、证明、结论标记
\newcommand{\solve}{\textbf{【解】}}
\newcommand{\solved}{{\hfill 【解毕】}}
\newcommand{\prove}{\textbf{【证明】}}
\newcommand{\proved}{{\hfill 【证毕】}}

% ==============================================================================
% 6. 彩色框定义（定义、定理）
% ==============================================================================

% 定义图片中的颜色 (近似值)
\definecolor{amzblue}{RGB}{0, 114, 189}   % 定义框的蓝色
\definecolor{amzpurple}{RGB}{119, 66, 188} % 定理框的紫色
\definecolor{boxbg}{RGB}{248, 248, 255}    % 极淡的背景色(GhostWhite)

% 全局 tcolorbox 样式设置
\tcbset{
    commonstyle/.style={
        enhanced,
        breakable,                  % 关键：允许环境跨页
        colback=boxbg,              % 内容区域背景色
        colframe=amzblue,           % 外部边框线颜色（虽然我们后面设为0pt，但影响标题位置）
        boxrule=0.5pt,              % 细微的边框线
        arc=2mm,                    % 整体圆角
        fonttitle=\bfseries\normalsize,
        coltitle=white,             % 标题文字颜色
        attach boxed title to top left={xshift=2mm, yshift=-3mm}, % 标题盒子的位置偏移
        boxed title style={
            before upper=\hspace{-2em}\noindent,
            colback=amzblue,        % 标题小方块的背景色
            colframe=amzblue,
            arc=1mm,                % 标题小方块的圆角
            outer arc=1mm,
            boxrule=0.5pt,
        },
        separator sign={\,},          % 空格
        description delimiters={（}{）},% 加上括号
        % drop shadow,                % 阴影
        top=4mm,                    % 增加顶部间距，防止标题盖住正文
    }
}

% 重新定义环境，允许传入颜色
\newtcbtheorem[number within=chapter]{definition}{定义}{
    commonstyle,
    colframe=amzblue,
    boxed title style={colback=amzblue, colframe=amzblue},
}{def}
\newtcbtheorem[number within=chapter]{theorem}{定理}{
    commonstyle,
    colframe=amzpurple,
    boxed title style={colback=amzpurple, colframe=amzpurple},
}{thm}

% ==============================================================================
% 7. 间距修正（全局微调）
% ==============================================================================
% 修改公式与前后文的紧凑度
\makeatletter
\g@addto@macro\normalsize{
    % --- 控制行间公式 (Display Math) ---
	\setlength\abovedisplayskip{0em plus 0.5em minus 0.25em}
	\setlength\belowdisplayskip{0em plus 0.5em minus 0.25em}
	\setlength\abovedisplayshortskip{0em plus 2pt minus 2pt}
	\setlength\belowdisplayshortskip{0em plus 2pt minus 2pt}

    % --- 控制行内公式 (Inline Math) 的避让机制 ---
    % 设置阈值：当两行间距小于 1pt 时触发避让
    \setlength\lineskiplimit{3pt} 
    % 设置避让间距：触发后强制留出 3pt 的缝隙，防止重叠
    \setlength\lineskip{3pt}
}
\makeatother

% 修改itemize环境的行间距
\usepackage{enumitem}
% \setlist[itemize]{nosep}
\setlist[itemize]{
    nosep,
    wide=2.5em,           % 关键：2em(段落缩进) + 0.5em(第一个字的中心)
    leftmargin=0pt,       % 配合 wide，确保列表不产生额外的整体偏移
    labelindent=\parindent+0.5em\relax,    % 强制让点出现在 2.5em 的位置，即对准首字中心
    listparindent=\parindent, 
    before=\noindent      % 保持你之前的设置
}

\setlist[enumerate,1]{ % 仅针对第一层级
    nosep,
    wide,
    label=（\arabic*）,
    labelsep=0pt,
    labelindent=\parindent+1em\relax
}

\newlist{romlist}{enumerate}{2}
% 第一层级 romlist - 正常缩进
\setlist[romlist,1]{
    nosep,
    wide,
    label=（\roman*）,
    labelsep=0pt,
    labelindent=\parindent+1em\relax
}
% 嵌套的 romlist（第二层级）- 更大的缩进
\setlist[romlist,2]{
    nosep,,
    wide,
    label=（\roman*）,
    labelsep=0pt,
    labelindent=\parindent+2em\relax
}

\newlist{indromlist}{enumerate}{1}
\setlist[indromlist,1]{
    nosep,
    wide,
    label=（\roman*）,
    labelsep=0pt,
    % itemindent=1em,   % 如果需要，可以调整项目缩进
    labelindent=\parindent+2em\relax
}